function startNewGame(){var a=function(){tic=$.extend(tic,tic.newGame()),$(".square").html(""),$(".winner").html(""),tic.player.switchOrder(),"c"===tic.player.check()&&aiMove()};$(".new-game").click(a),a()}function setup(){return{newGame:function(){return{emptySquares:emptySquares(),turn:turnOrder(),sequence:currentSequence(),rotation:rotation(initiateRotation),x:recordTakenSquares(),o:recordTakenSquares(),gameOver:!1}},setsOfThree:[[1,2,3],[1,5,9],[1,4,7],[2,5,8],[3,6,9],[3,5,7],[4,5,6],[7,8,9]],player:playerOrder(),firstPlayerSequences:allSequences(),secondPlayerSequences:allSequences()}}function emptySquares(){var a=[1,2,3,4,5,6,7,8,9];return{checkSquare:function(b){var c=a.indexOf(b);return c>-1?!0:!1},remove:function(b){var c=a.indexOf(b);a.splice(c,1)},checkEmpty:function(){return a}}}function turnOrder(){var a=0;return{increment:function(){a+=1},check:function(){return a}}}function currentSequence(){var a=[];return{add:function(b){a.push(b)},check:function(){return a}}}function allSequences(){var a=[],b=[];return{add:function(a,b){var c=findMatch(a,b,0,[],b.length);c.length>0?c[0].frequency+=1:a.push({sequence:b,frequency:1})},arrange:function(a){a=a.sort(function(a,b){return b.frequency-a.frequency})},check:function(c){return"wins"===c?a:b}}}function findMatch(a,b,c,d,e){return 0===b.length||0===a.length?a:c>=e?a:(_.each(a,function(a){console.log("exact:    ",a.sequence[c]+" "+b[c]),console.log("oriented: ",handleOrientaion(a.sequence[0],a.sequence[c])+" "+b[c]),(a.sequence[c]===b[c]||handleOrientaion(a.sequence[0],a.sequence[c])===b[c])&&d.push(a)}),findMatch(d,b,c+1,[],e))}function handleOrientaion(a,b){function c(a){return d=a.first.indexOf(b),e=a.second.indexOf(b),d>-1?a.second[d]:a.first[e]}var d,e,f={first:[1,2,3,5,6,9],second:[1,4,7,5,8,9]},g={first:[1,2,4,5,7,8],second:[3,2,6,5,9,8]};return[1,3,7,9].indexOf(a)>-1?c(f):[2,4,6,8].indexOf(a)>-1?c(g):void 0}function playerOrder(){var a=["c","h"];return{switchOrder:function(){a=a.reverse()},check:function(){return a[0]}}}function rotation(a){var b=[],c=[{squares:[1,2],rotation:[1,2,3,4,5,6,7,8,9]},{squares:[3,6],rotation:[3,6,9,2,5,8,1,4,7]},{squares:[9,8],rotation:[9,8,7,6,5,4,3,2,1]},{squares:[7,4],rotation:[7,4,1,8,5,2,9,6,3]}];return{set:function(d){a()&&(b=_.find(c,function(a){return a.squares.indexOf(d)>-1}).rotation)},check:function(){return b}}}function initiateRotation(){var a=tic.sequence.check();return 1===a.length&&5!==a[0]||2===a.length&&5===a[0]}function recordTakenSquares(){var a=[];return{add:function(b){a.push(b)},check:function(){return a}}}function huMove(){$(".square").click(function(){var a=parseInt($(this).attr("id"));tic.emptySquares.checkSquare(a)&&!tic.gameOver&&(processMove(a,"x"),tic.gameOver||aiMove())})}function aiMove(){var a=aiForced("o").concat(aiForced("x")),b=a[0]||aiTactical()||aiRandom(tic.emptySquares.checkEmpty().slice());console.log("ai chose: ",b),processMove(b,"o")}function aiRandom(a){var b=Math.floor(Math.random()*a.length),c=a[b];return c}function aiForced(a){var b=[];return _.each(tic.setsOfThree,function(c){var d=_.difference(c,tic[a].check());1===d.length&&tic.emptySquares.checkEmpty().indexOf(d[0])>-1&&b.push(d[0])}),b}function aiTactical(){var a="c"===tic.player.check()?tic.firstPlayerSequences.check("wins"):tic.secondPlayerSequences.check("wins"),b="h"===tic.player.check()?tic.firstPlayerSequences.check("wins"):tic.secondPlayerSequences.check("wins"),c=[],d=[],e=convertSequence(tic.sequence.check(),!0),f=tic.sequence.check().length;return c=a.length>0?findMatch(a,e,0,[],f):[],c[0]?c[0].sequence[tic.turn.check()]:(c=b.length>0?findMatch(b,e,0,[],f):[],c[0]?(_.each(c,function(a){d.push(a.sequence[tic.turn.check()])}),console.log("we've found some baddies ",d),d=_.union(d,_.map(d,function(a){return handleOrientaion(tic.sequence.check()[0],a)})),console.log("now we got there counterparts ",d),aiRandom(_.difference(tic.emptySquares.checkEmpty(),d))):!1)}function processMove(a,b){appendPiece("#"+a,determineTemplate(b)),tic.emptySquares.remove(a),tic.sequence.add(a),tic.rotation.set(a),tic[b].add(a),console.log("rotation: ",tic.rotation.check()),gameOver(b),tic.turn.increment()}function gameOver(a){checkForThree(tic.setsOfThree,0,0,a)?($(".winner").text(a.toUpperCase()+" Wins!"),record("wins")):0===tic.emptySquares.checkEmpty().length&&($(".winner").text("Draw!"),record("draws"))}function record(a){tic.gameOver=!0,tic.turn.check()%2===0?tic.firstPlayerSequences.add(tic.firstPlayerSequences.check(a),convertSequence(tic.sequence.check(),!0)):tic.secondPlayerSequences.add(tic.secondPlayerSequences.check(a),convertSequence(tic.sequence.check(),!0))}function checkForThree(a,b,c,d){if(3===c)return!0;if(b>=a.length)return!1;var e=a[b][c];return $("#"+e).children().hasClass(d)?checkForThree(a,b,c+1,d):checkForThree(a,b+1,0,d)}function convertSequence(a,b){var c=[];return _.each(a,function(a){c.push(b?tic.rotation.check().indexOf(a)+1:tic.rotation.check()[a-1])}),c}function verifyAllThrees(a){var b=runEachSet(tic.setsOfThree,displaySet);setInterval(function(){b(a),checkForThree(tic.setsOfThree,0,0,a)},1500)}function runEachSet(a,b){var c=0;return function(d){c=c<a.length?c:0,$(".square").html(""),b(a[c],d),c++}}function displaySet(a,b){a.forEach(function(a){var c="#"+a,d=determineTemplate(b);appendPiece(c,d)})}function determineTemplate(a){return _.template($("#"+a).text())}function appendPiece(a,b){$(a).append(b)}var tic=setup();$(function(){huMove(),startNewGame()});